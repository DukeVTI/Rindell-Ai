<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rindell AI - WhatsApp Document Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --secondary: #34B7F1;
            --danger: #DC3545;
            --success: #28A745;
            --warning: #FFC107;
            --dark: #1E1E1E;
            --light: #F5F5F5;
            --border: #E0E0E0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #2a9fd8;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .qr-container {
            text-align: center;
            padding: 40px;
            background: var(--light);
            border-radius: 12px;
            margin: 30px 0;
        }

        .qr-container img {
            max-width: 300px;
            border: 5px solid white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 0;
        }

        .status-connected {
            background: var(--success);
            color: white;
        }

        .status-disconnected {
            background: var(--danger);
            color: white;
        }

        .status-connecting {
            background: var(--warning);
            color: var(--dark);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .document-list {
            margin: 30px 0;
        }

        .document-item {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .document-item:hover {
            border-color: var(--primary);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .document-title {
            font-weight: 600;
            font-size: 18px;
            color: var(--dark);
        }

        .document-date {
            color: #666;
            font-size: 14px;
        }

        .document-summary {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 30px;
        }

        .nav-tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .instructions {
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .instructions h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin: 10px 0;
            line-height: 1.6;
        }

        .link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }

        .link:hover {
            color: var(--primary-dark);
        }

        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .metrics-table th,
        .metrics-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .metrics-table th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }

        .metric-good {
            color: var(--success);
            font-weight: 600;
        }

        .metric-bad {
            color: var(--danger);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Rindell AI</h1>
            <p>Your WhatsApp Document Assistant</p>
        </div>

        <div class="content">
            <!-- Alert -->
            <div id="alert" class="alert"></div>

            <!-- Login Page -->
            <div id="loginPage" class="page active">
                <h2>Welcome Back</h2>
                <p style="margin: 20px 0;">Sign in to your Rindell account</p>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Sign In</button>
                </form>

                <p style="margin-top: 20px; text-align: center;">
                    Don't have an account? 
                    <span class="link" onclick="showPage('registerPage')">Register here</span>
                </p>
            </div>

            <!-- Register Page -->
            <div id="registerPage" class="page">
                <h2>Create Account</h2>
                <p style="margin: 20px 0;">Join Rindell to start processing documents</p>
                
                <form id="registerForm">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label>WhatsApp Number (with country code)</label>
                        <input type="tel" id="registerPhone" placeholder="+1234567890" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Account</button>
                </form>

                <p style="margin-top: 20px; text-align: center;">
                    Already have an account? 
                    <span class="link" onclick="showPage('loginPage')">Sign in</span>
                </p>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>Dashboard</h2>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>

                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('overviewTab')">Overview</button>
                    <button class="nav-tab" onclick="showTab('whatsappTab')">WhatsApp</button>
                    <button class="nav-tab" onclick="showTab('documentsTab')">Documents</button>
                    <button class="nav-tab" onclick="showTab('metricsTab')">Metrics</button>
                </div>

                <!-- Overview Tab -->
                <div id="overviewTab" class="tab-content active">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <h3>WhatsApp Status</h3>
                            <div class="value" id="waStatusValue">‚Äî</div>
                        </div>
                        <div class="stat-card">
                            <h3>Documents Processed</h3>
                            <div class="value" id="docsProcessed">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Average Time</h3>
                            <div class="value" id="avgTime">‚Äî</div>
                        </div>
                    </div>

                    <div class="instructions">
                        <h3>üìö How It Works</h3>
                        <ol>
                            <li>Connect your WhatsApp account using the QR code</li>
                            <li>Send any document (PDF, DOCX, TXT, or image) via WhatsApp</li>
                            <li>Rindell automatically detects and processes your document</li>
                            <li>Receive a professional summary within 30 seconds</li>
                            <li>Access all your document history right here</li>
                        </ol>
                    </div>
                </div>

                <!-- WhatsApp Tab -->
                <div id="whatsappTab" class="tab-content" style="display: none;">
                    <h3>WhatsApp Connection</h3>
                    <div id="waConnectionStatus">
                        <p>Loading connection status...</p>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div id="documentsTab" class="tab-content" style="display: none;">
                    <h3>Your Documents</h3>
                    <div id="documentsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading documents...</p>
                        </div>
                    </div>
                </div>

                <!-- Metrics Tab -->
                <div id="metricsTab" class="tab-content" style="display: none;">
                    <h3>System Metrics</h3>
                    <div id="metricsContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading metrics...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = window.location.origin;
        let token = localStorage.getItem('rindell_token');
        let userId = localStorage.getItem('rindell_userId');
        let currentUser = null;
        let refreshInterval = null;

        // Initialize
        if (token && userId) {
            verifyToken();
        }

        // Helper Functions
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.className = 'alert';
            }, 5000);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function showTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tabId).style.display = 'block';

            // Load data for specific tabs
            if (tabId === 'documentsTab') loadDocuments();
            if (tabId === 'metricsTab') loadMetrics();
            if (tabId === 'whatsappTab') loadWhatsAppStatus();
        }

        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Request failed');
            }

            return response.json();
        }

        // Authentication
        async function verifyToken() {
            try {
                const data = await apiCall('/api/auth/me');
                currentUser = data.user;
                showPage('dashboardPage');
                loadDashboard();
            } catch (error) {
                localStorage.removeItem('rindell_token');
                localStorage.removeItem('rindell_userId');
                token = null;
                userId = null;
                showPage('loginPage');
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const data = await apiCall('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                token = data.token;
                userId = data.user.id;
                localStorage.setItem('rindell_token', token);
                localStorage.setItem('rindell_userId', userId);
                currentUser = data.user;

                showAlert('Login successful!', 'success');
                showPage('dashboardPage');
                loadDashboard();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const data = await apiCall('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, phone, password })
                });

                token = data.token;
                userId = data.user.id;
                localStorage.setItem('rindell_token', token);
                localStorage.setItem('rindell_userId', userId);
                currentUser = data.user;

                showAlert('Registration successful!', 'success');
                showPage('dashboardPage');
                loadDashboard();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });

        function logout() {
            localStorage.removeItem('rindell_token');
            localStorage.removeItem('rindell_userId');
            token = null;
            userId = null;
            currentUser = null;
            if (refreshInterval) clearInterval(refreshInterval);
            showPage('loginPage');
            showAlert('Logged out successfully', 'info');
        }

        // Dashboard Functions
        async function loadDashboard() {
            loadOverview();
            loadWhatsAppStatus();
            
            // Auto-refresh every 5 seconds
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                loadOverview();
                loadWhatsAppStatus();
            }, 5000);
        }

        async function loadOverview() {
            try {
                const stats = await apiCall(`/api/documents/${userId}/stats`);
                document.getElementById('docsProcessed').textContent = stats.totalDocuments || 0;
                
                if (stats.averageProcessingTime) {
                    const avgSec = (stats.averageProcessingTime / 1000).toFixed(1);
                    document.getElementById('avgTime').textContent = `${avgSec}s`;
                } else {
                    document.getElementById('avgTime').textContent = '‚Äî';
                }
            } catch (error) {
                console.error('Failed to load overview:', error);
            }
        }

        async function loadWhatsAppStatus() {
            try {
                const status = await apiCall(`/api/whatsapp/status?userId=${userId}`);
                
                let statusHtml = '';
                let statusText = 'Disconnected';
                
                if (status.connected) {
                    statusText = 'Connected';
                    statusHtml = `
                        <div style="text-align: center;">
                            <span class="status-badge status-connected">‚úì Connected</span>
                            <p style="margin: 20px 0;">Your WhatsApp is connected and ready to receive documents!</p>
                            <button class="btn btn-danger" onclick="disconnectWhatsApp()">Disconnect</button>
                        </div>
                    `;
                } else if (status.qrCode) {
                    statusText = 'Scan QR';
                    statusHtml = `
                        <div style="text-align: center;">
                            <span class="status-badge status-connecting">‚è≥ Waiting for Connection</span>
                            <div class="qr-container">
                                <img src="${status.qrCode}" alt="QR Code">
                            </div>
                            <p><strong>Scan this QR code with WhatsApp:</strong></p>
                            <ol style="text-align: left; display: inline-block; margin: 20px auto;">
                                <li>Open WhatsApp on your phone</li>
                                <li>Tap Menu (‚ãÆ) or Settings</li>
                                <li>Tap "Linked Devices"</li>
                                <li>Tap "Link a Device"</li>
                                <li>Scan this QR code</li>
                            </ol>
                        </div>
                    `;
                } else {
                    statusHtml = `
                        <div style="text-align: center;">
                            <span class="status-badge status-disconnected">‚úó Not Connected</span>
                            <p style="margin: 20px 0;">Connect your WhatsApp to start processing documents</p>
                            <button class="btn btn-primary" onclick="connectWhatsApp()">Connect WhatsApp</button>
                        </div>
                    `;
                }

                document.getElementById('waStatusValue').textContent = statusText;
                document.getElementById('waConnectionStatus').innerHTML = statusHtml;
            } catch (error) {
                console.error('Failed to load WhatsApp status:', error);
            }
        }

        async function connectWhatsApp() {
            try {
                await apiCall('/api/whatsapp/connect', {
                    method: 'POST',
                    body: JSON.stringify({ userId })
                });
                showAlert('Generating QR code...', 'info');
                setTimeout(loadWhatsAppStatus, 2000);
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function disconnectWhatsApp() {
            if (!confirm('Are you sure you want to disconnect WhatsApp?')) return;
            
            try {
                await apiCall('/api/whatsapp/disconnect', {
                    method: 'POST',
                    body: JSON.stringify({ userId })
                });
                showAlert('WhatsApp disconnected', 'info');
                loadWhatsAppStatus();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function loadDocuments() {
            try {
                const documents = await apiCall(`/api/documents/${userId}`);
                const container = document.getElementById('documentsList');

                if (documents.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="font-size: 18px; color: #666;">No documents yet</p>
                            <p style="margin-top: 10px;">Send a document via WhatsApp to get started!</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                for (const doc of documents) {
                    const date = new Date(doc.created_at).toLocaleString();
                    html += `
                        <div class="document-item">
                            <div class="document-header">
                                <div>
                                    <div class="document-title">${doc.filename || 'Document'}</div>
                                    <div class="document-date">${date}</div>
                                </div>
                                <div>
                                    <span class="status-badge ${doc.status === 'completed' ? 'status-connected' : 'status-connecting'}">
                                        ${doc.status}
                                    </span>
                                </div>
                            </div>
                    `;

                    if (doc.summary) {
                        html += `
                            <div class="document-summary">
                                <strong>üìù Summary:</strong><br>
                                ${doc.summary.executiveSummary || 'Processing...'}
                            </div>
                        `;
                    }

                    html += `</div>`;
                }

                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load documents:', error);
                document.getElementById('documentsList').innerHTML = `
                    <p style="color: var(--danger);">Failed to load documents: ${error.message}</p>
                `;
            }
        }

        async function loadMetrics() {
            try {
                const metrics = await apiCall('/api/metrics/system');
                const container = document.getElementById('metricsContent');

                let html = `
                    <table class="metrics-table">
                        <tr>
                            <th>Metric</th>
                            <th>Target</th>
                            <th>Actual</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td>Processing Time</td>
                            <td>‚â§ 30 seconds</td>
                            <td>${(metrics.processingTime.average / 1000).toFixed(2)}s</td>
                            <td class="${metrics.processingTime.average <= 30000 ? 'metric-good' : 'metric-bad'}">
                                ${metrics.processingTime.average <= 30000 ? '‚úì Pass' : '‚úó Fail'}
                            </td>
                        </tr>
                        <tr>
                            <td>Detection Accuracy</td>
                            <td>‚â• 95%</td>
                            <td>${metrics.detectionAccuracy.toFixed(1)}%</td>
                            <td class="${metrics.detectionAccuracy >= 95 ? 'metric-good' : 'metric-bad'}">
                                ${metrics.detectionAccuracy >= 95 ? '‚úì Pass' : '‚úó Fail'}
                            </td>
                        </tr>
                        <tr>
                            <td>Total Documents</td>
                            <td>‚Äî</td>
                            <td>${metrics.totalDocuments}</td>
                            <td>‚Äî</td>
                        </tr>
                        <tr>
                            <td>Queue Jobs</td>
                            <td>‚Äî</td>
                            <td>${metrics.queueStats.waiting} waiting, ${metrics.queueStats.active} active</td>
                            <td>‚Äî</td>
                        </tr>
                    </table>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load metrics:', error);
                document.getElementById('metricsContent').innerHTML = `
                    <p style="color: var(--danger);">Failed to load metrics: ${error.message}</p>
                `;
            }
        }
    </script>
</body>
</html>
